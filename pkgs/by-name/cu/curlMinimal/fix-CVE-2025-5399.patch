From d1145df24de8f80e6b167fbc4f28b86bcd0c6832 Mon Sep 17 00:00:00 2001
From: z2_ <88509734+z2-2z@users.noreply.github.com>
Date: Sat, 31 May 2025 14:22:00 +0200
Subject: [PATCH] ws: handle blocked sends better

Closes #17496
---
 lib/ws.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/lib/ws.c b/lib/ws.c
index 93ec3a785ad9..61ab5019fd81 100644
--- a/lib/ws.c
+++ b/lib/ws.c
@@ -1384,6 +1384,10 @@ CURL_EXTERN CURLcode curl_ws_send(CURL *d, const void *buffer_arg,
       if(n < 0 && (result != CURLE_AGAIN))
         goto out;
       ws->sendbuf_payload += Curl_bufq_len(&ws->sendbuf) - prev_len;
+      if(!ws->sendbuf_payload) {
+        result = CURLE_AGAIN;
+        goto out;
+      }
     }
 
     /* flush, blocking when in callback */
